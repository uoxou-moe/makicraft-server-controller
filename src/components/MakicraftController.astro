---
---

<div class="container">
  <div>
    <button id="getStatusBtn">状態を取得</button>
    <button id="startInstanceBtn">インスタンスを起動</button>
  </div>

  <h3>結果:</h3>
  <pre id="result">ここに結果が表示されます。</pre>
</div>

<style>
  .container { max-width: 600px; margin: 2em auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  input, button { padding: 10px; margin: 5px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
  button { cursor: pointer; background-color: #0d6efd; color: white; border-color: #0d6efd; transition: background-color 0.2s; }
  button:hover { background-color: #0b5ed7; }
  #result { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; min-height: 100px; font-family: 'Courier New', Courier, monospace; }
</style>

<script>
  type AppConfig = {
    apiEndpoint: string | null;
    instanceId: string | null;
  };

  let appConfig: AppConfig | null = null;

  /**
   * サイトの設定情報を非同期で取得する関数。
   * @returns {Promise<AppConfig>} - AppConfig型のオブジェクトを返すPromise
   */
  async function getAppConfig(): Promise<AppConfig> {
    // キャッシュがあればそれを返す
    if (appConfig) {
      return appConfig;
    }

    try {
      // Vercelでホストされている自分のサイトのAPIルートを叩く
      const response = await fetch('/api/config');
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to load configuration');
      }

      const configData: AppConfig = await response.json();
      appConfig = configData; // 結果をキャッシュ
      return appConfig;

    } catch (error) {
      console.error('Configuration fetch error:', error);
      return { apiEndpoint: null, instanceId: null };
    }
  }

  const getStatusBtn = document.getElementById('getStatusBtn');
  const startInstanceBtn = document.getElementById('startInstanceBtn');
  const resultDiv = document.getElementById('result');

  /**
   * APIリクエストを送信する関数
   * @param {string} path - APIのパス (例: '/status')
   * @param {string} instanceId - EC2インスタンスのID
   */
  async function sendRequest(path: string, instanceId: string) {
    if (!resultDiv) return;

    resultDiv.textContent = '設定情報を取得中...';
    const config = await getAppConfig();
    const apiBaseUrl = config.apiEndpoint;

    // 設定情報が取得できなかった場合のエラー処理
    if (!apiBaseUrl) {
      resultDiv.textContent = 'エラー: APIエンドポイントの設定を取得できませんでした。';
      return;
    }

    resultDiv.textContent = '処理中...';

    if (!instanceId) {
      resultDiv.textContent = 'エラー: Missing instance ID';
      return;
    }

    try {
      const response = await fetch(`${apiBaseUrl}${path}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ instanceId: instanceId }),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || '不明なエラーが発生しました');
      }

      resultDiv.textContent = JSON.stringify(data, null, 2);

    } catch (error) {
      console.error('API request failed:', error);
      if (error instanceof Error) {
        resultDiv.textContent = `エラー: ${error.message}`;
      } else {
        resultDiv.textContent = '予期せぬエラーが発生しました。';
      }
    }
  }

  getStatusBtn?.addEventListener('click', async () => {
    const config = await getAppConfig();
    if (config.instanceId) {
      sendRequest('/status', config.instanceId);
    } else {
      console.error("Instance ID is not configured.");
    }
  });

  startInstanceBtn?.addEventListener('click', async () => {
    const config = await getAppConfig();
    if (config.instanceId) {
      sendRequest('/start', config.instanceId);
    } else {
      console.error("Instance ID is not configured.");
    }
  });
</script>
